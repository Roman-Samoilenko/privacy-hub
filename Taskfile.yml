version: '3'

output: prefixed

vars:
  PROJECT_NAME: privacy-hub
  DOCKER_IMAGE: privacy-hub-dns
  CONTAINER_NAME: privacy-hub-dns
  BINARY_HOST: privacy-hub
  BINARY_DNS: dnsserver
  GO_FLAGS: -ldflags="-w -s"
  CONFIG_PATH: configs/config.yaml

env:
  CGO_ENABLED: 0
  GOOS: linux
  GOARCH: amd64

dotenv:
  - .env

tasks:
  default:
    desc: "–ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã"
    cmds:
      - task --list

  # ==================== –°–ë–û–†–ö–ê ====================
  
  build:
    desc: "–°–æ–±—Ä–∞—Ç—å –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (host + DNS container)"
    deps:
      - build:host
      - build:docker
    cmds:
      - echo "‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–æ–±—Ä–∞–Ω—ã"

  build:host:
    desc: "–°–æ–±—Ä–∞—Ç—å host —É—Ç–∏–ª–∏—Ç—É"
    cmds:
      - go mod tidy
      - go build -mod=mod -ldflags="-w -s" -o privacy-hub ./cmd/privacy-hub
      - chmod +x privacy-hub

  build:docker:
    desc: "–°–æ–±—Ä–∞—Ç—å DNS Docker-–æ–±—Ä–∞–∑"
    sources:
      - Dockerfile
      - cmd/dnsserver/**/*.go
      - internal/**/*.go
      - docker-compose.yml
    cmds:
      - echo "üê≥ –°–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–∞..."
      - docker-compose build
      - echo "‚úÖ Docker-–æ–±—Ä–∞–∑ —Å–æ–±—Ä–∞–Ω"

  # ==================== –ó–ê–ü–£–°–ö ====================

  up:
    desc: "–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π —Å—Ç–µ–∫ (Docker + Host)"
    deps:
      - build
    cmds:
      - task: docker:up
      - echo "‚è≥ –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ DNS-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (5 —Å–µ–∫)..."
      - sleep 5
      - echo "üöÄ –ó–∞–ø—É—Å–∫ host-–ø—Ä–æ—Ü–µ—Å—Å–∞..."
      - echo "‚ö†Ô∏è  –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ -> task down"
      - sudo ./{{.BINARY_HOST}}

  docker:up:
    desc: "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ DNS-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
    cmds:
      - echo "üê≥ –ó–∞–ø—É—Å–∫ DNS-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
      - docker-compose up -d
      - echo "‚úÖ DNS-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω"

  docker:logs:
    desc: "–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ DNS-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
    cmds:
      - docker-compose logs -f

  # ==================== –û–°–¢–ê–ù–û–í–ö–ê ====================

  down:
    desc: "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã"
    cmds:
      - echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
      - docker-compose down
      - echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

  stop:
    desc: "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å host-–ø—Ä–æ—Ü–µ—Å—Å –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
    cmds:
      - task: down
      - echo "üßπ –û—á–∏—Å—Ç–∫–∞ iptables –ø—Ä–∞–≤–∏–ª..."
      - sudo iptables -t nat -F || true
      - echo "‚úÖ –í—Å–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"

  # ==================== –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï ====================

  test:
    desc: "–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã"
    cmds:
      - echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
      - go test -v -race -coverprofile=coverage.out ./...
      - go tool cover -html=coverage.out -o coverage.html
      - echo "‚úÖ –¢–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã. –û—Ç—á–µ—Ç -> coverage.html"

  test:unit:
    desc: "–¢–æ–ª—å–∫–æ unit-—Ç–µ—Å—Ç—ã (–±–µ–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö)"
    cmds:
      - go test -v -short ./...

  bench:
    desc: "–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–µ–Ω—á–º–∞—Ä–∫–∏"
    cmds:
      - go test -bench=. -benchmem ./internal/dnsresolver

  # ==================== –ü–†–û–í–ï–†–ö–ò ====================

  check:
    desc: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
    cmds:
      - task: check:api
      - task: check:dns
      - task: check:proxy

  check:api:
    desc: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å API (–ø–æ—Ä—Ç 8000)"
    cmds:
      - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ API..."
      - curl -f http://localhost:8000/health || (echo "‚ùå API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç" && exit 1)
      - echo "‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç"

  check:dns:
    desc: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å DNS-—Ä–µ–∑–æ–ª–≤–µ—Ä (–ø–æ—Ä—Ç 9000)"
    cmds:
      - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS..."
      - dig @127.0.0.1 -p 9000 +short google.com || (echo "‚ùå DNS –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç" && exit 1)
      - echo "‚úÖ DNS —Ä–∞–±–æ—Ç–∞–µ—Ç"

  check:proxy:
    desc: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å HTTP-–ø—Ä–æ–∫—Å–∏ (–ø–æ—Ä—Ç 3128)"
    cmds:
      - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∫—Å–∏..."
      - curl -x http://localhost:3128 -s -o /dev/null -w "%{http_code}" http://google.com | grep -q 200 || (echo "‚ùå –ü—Ä–æ–∫—Å–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç" && exit 1)
      - echo "‚úÖ –ü—Ä–æ–∫—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç"

  check:user-agent:
    desc: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–º–µ–Ω—É User-Agent"
    cmds:
      - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ User-Agent..."
      - curl -x http://localhost:3128 http://ifconfig.me/ua
      - echo ""

  # ==================== –°–ï–†–¢–ò–§–ò–ö–ê–¢–´ ====================

  certs:gen:
    desc: "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å MITM —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã"
    cmds:
      - echo "üîê –ì–µ–Ω–µ—Ä–∞—Ü–∏—è CA —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞..."
      - mkdir -p certs
      - |
        openssl genrsa -out certs/ca.key 2048
        openssl req -new -x509 -days 3650 \
          -key certs/ca.key \
          -out certs/ca.crt \
          -subj "/C=RU/ST=Smolensk/L=Smolensk/O=PrivacyHub/CN=PrivacyHub Root CA"
      - echo "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —Å–æ–∑–¥–∞–Ω—ã –≤ certs/"
      - echo "‚ö†Ô∏è  –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ certs/ca.crt –≤ –±—Ä–∞—É–∑–µ—Ä (—Å–º. README)"

  certs:install:
    desc: "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å CA —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤ —Å–∏—Å—Ç–µ–º—É (Linux)"
    preconditions:
      - test -f certs/ca.crt
    cmds:
      - echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ CA –≤ —Å–∏—Å—Ç–µ–º—É..."
      - sudo cp certs/ca.crt /usr/local/share/ca-certificates/privacy-hub.crt
      - sudo update-ca-certificates
      - echo "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä."

  certs:clean:
    desc: "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã"
    cmds:
      - echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."
      - rm -rf certs/
      - echo "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —É–¥–∞–ª–µ–Ω—ã"

  certs:install-firefox:
    desc: "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å CA —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤ Firefox"
    preconditions:
      - test -f certs/ca.crt
      - command -v certutil >/dev/null 2>&1 || (echo "‚ùå –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: sudo apt install libnss3-tools" && exit 1)
    vars:
      CERT_NAME: "PrivacyHub Root CA"
      CERT_FILE:
        sh: realpath certs/ca.crt
    cmds:
      - |
        echo "ü¶ä –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ Firefox..."
        for profile in ~/.mozilla/firefox/*.default*; do
          if [ -d "$profile" ]; then
            echo "  ‚Üí –ü—Ä–æ—Ñ–∏–ª—å: $(basename $profile)"
            certutil -A -n "{{.CERT_NAME}}" -t "CT,C,C" -i "{{.CERT_FILE}}" -d sql:"$profile"
          fi
        done
      - echo "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤–æ –≤—Å–µ –ø—Ä–æ—Ñ–∏–ª–∏ Firefox"
      - echo "‚ö†Ô∏è  –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Firefox"


  # ==================== –†–ê–ó–†–ê–ë–û–¢–ö–ê ====================

  dev:
    desc: "–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö)"
    deps:
      - install:air
    cmds:
      - air -c .air.toml

  lint:
    desc: "–ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–∏–Ω—Ç–µ—Ä—ã"
    cmds:
      - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞..."
      - gofmt -l -s .
      - go vet ./...
      - golangci-lint run || echo "‚ö†Ô∏è  –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ golangci-lint -> https://golangci-lint.run/usage/install/"

  fmt:
    desc: "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥"
    cmds:
      - echo "‚ú® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ..."
      - gofmt -w -s .
      - go mod tidy
      - echo "‚úÖ –ö–æ–¥ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω"

  # ==================== –û–ß–ò–°–¢–ö–ê ====================

  clean:
    desc: "–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å–±–æ—Ä–∫–∏"
    cmds:
      - echo "üßπ –û—á–∏—Å—Ç–∫–∞..."
      - rm -f {{.BINARY_HOST}} {{.BINARY_DNS}}
      - rm -f coverage.out coverage.html
      - rm -rf vendor/
      - docker-compose down -v --remove-orphans || true
      - echo "‚úÖ –û—á–∏—â–µ–Ω–æ"

  clean:docker:
    desc: "–£–¥–∞–ª–∏—Ç—å Docker-–æ–±—Ä–∞–∑—ã –ø—Ä–æ–µ–∫—Ç–∞"
    cmds:
      - docker-compose down --rmi all -v || true
      - docker image prune -f

  reset:
    desc: "–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å (–æ—á–∏—Å—Ç–∫–∞ + —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤)"
    cmds:
      - task: stop
      - task: clean
      - task: clean:docker
      - task: certs:clean
      - echo "üîÑ –ü—Ä–æ–µ–∫—Ç —Å–±—Ä–æ—à–µ–Ω"

  # ==================== –õ–û–ì–ò –ò –ú–û–ù–ò–¢–û–†–ò–ù–ì ====================

  logs:
    desc: "–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤"
    cmds:
      - docker-compose logs -f

  ps:
    desc: "–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
    cmds:
      - echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
      - docker-compose ps
      - echo ""
      - echo "üîå –ü–æ—Ä—Ç—ã:"
      - sudo netstat -tuln | grep -E '8000|3128|9000' || echo "–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ—Ä—Ç–æ–≤"

 